<!DOCTYPE HTML>
<html>
<head>
        <title>教學筆記系統</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>   
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
        <!-- Firebase js -->
        <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>    
        <!-- Firepad related js -->  
        <script src="/javascripts/codemirror.js"></script>     
        <script src="/javascripts/firepad.js"></script> 
        <script src="/javascripts/firebase-init.js"></script>
        <!-- Firepad css -->
        <link rel="stylesheet" href="/stylesheets/codemirror.css" />
        <link rel="stylesheet" href="/stylesheets/firepad.css" />
        
        
        <!-- This page css -->
        <link rel="stylesheet" href="/stylesheets/noteWatchPage.css" />
        <link rel="stylesheet" href="/stylesheets/style.css">

        <script src="/javascripts/keywordOverlay.js"></script>
        <script src="/javascripts/bootbox.min.js"></script>

        <script>            
            function init(){  
                initFirebase();
                // Add student from data into select list
                var userRef = firebase.database().ref("users/");
                userRef.on('value',function(data){
                    $('#studentSelect').html("");
                    for(var i in data.val()){
                        if(data.val()[i].character == "student"){
                            var name = data.val()[i].name;
                            var email = data.val()[i].email;
                            var newOption = document.createElement('option');
                            newOption.innerHTML = name + ' < ' + email + ' > ' ;
                            newOption.setAttribute('value',email);
                            $('#studentSelect').append( newOption );
                        }
                    }
                });
                // Add slide link
                var slideLiElement = $('<li></li>').html('<a href="' + parsePPTURL("<%= pptUrl %>") +'" target="#"><span class="glyphicon glyphicon-file"></span> 投影片</a>');
                var liveLiElement = $('<li></li>').html('<a href="#" onclick="liveCodePrompt()"><span class="glyphicon glyphicon-globe"></span> 投影片廣播</a>');
                $('#navList').append(slideLiElement);
                $('#navList').append(liveLiElement);

                // Select list click
                $('#studentSelect').change(function(){
                    var name = $('#studentSelect').find(':selected').text();
                    var email = $('#studentSelect').find(':selected').val();
                    $('#studentName').text(name);
                    var userEID = email.split('@')[0];
                    choosePad(userEID);
                });

                // Random choose button
                $('#randomStudent').click(function(){
                    var options = $('#studentSelect').find('option');
                    var randomIndex = Math.floor((Math.random() * options.length));
                    var name = options.eq(randomIndex).text();
                    var email = options.eq(randomIndex).val();
                    $('#studentName').text(name);
                    var userEID = email.split('@')[0];
                    choosePad(userEID);
                });
                
            }; 
            // change pad depend on user
            function choosePad(userEID){
                var firepadRef = firebase.database().ref('/'+'note-'+userEID).child('<%= title %>');
                var firepadContainer = document.getElementById('firepad-container');
                firepadContainer.innerHTML = "";
                var codeMirror = CodeMirror(document.getElementById('firepad-container'), { lineWrapping: true });
                hyperlinkOverlay(codeMirror);
                qaOverlay(codeMirror);
                askingOverlay(codeMirror);
                var firepad = Firepad.fromCodeMirror(firepadRef, codeMirror,
                    { richTextToolbar: true, richTextShortcuts: true , userId:"<%= user.displayName %>" }
                );
                $('#showQA').html("");
                $('#showAsking').html("");
                firepad.on('ready', function() {
                    var contentArray = firepad.getText().split("\n");
                    var qaPatt = new RegExp("(^\/Q .*)|(^\/A .*)","i");
                    var qPatt = new RegExp("(^\/Q .*)","i");
                    var aPatt = new RegExp("(^\/A .*)","i");
                    var askingPatt = new RegExp("(^\/[?] .*)","i");
                    for( var i = 0; i < contentArray.length; i++){
                        if( askingPatt.test(contentArray[i]) ){
                            $('#showAsking').append(contentArray[i] + '\n\n');
                        }
                        else if( qaPatt.test(contentArray[i]) ){
                            if (qPatt.test(contentArray[i])){
                                if ( document.getElementById("showQA").innerHTML != "" ){
                                    $('#showQA').append('\n');
                                }
                                $('#showQA').append(contentArray[i] + '\n');
                            }else{
                                $('#showQA').append(contentArray[i] + '\n');
                            } 
                        }
                    }
                });
            }
            function parsePPTURL(pptUrl){
                var patt = /https:.*?(quot;|#39)/;
                var match = patt.exec(pptUrl);
                var url = match[0].substr(0,match[0].length - 4);
                url = url.replace(/&amp;/g,"&");
                return url;
            }
            function liveCodePrompt(){
                var promiseResult = new Promise(function(resolve,reject){
                    // get the live code according to the chapter title 
                    var courseRef = firebase.database().ref("courses/" + "<%= courseName %>");
                    courseRef.on("value",function(data){
                        resolve(data.val().live);
                    });     
                });
                promiseResult.then(value => {
                        var dialog = bootbox.dialog({
                            title: '投影片廣播功能 ( 使用Powerpoint 線上展示 )',
                            size : 'large',
                            message: "<h4>請在下方輸入框貼上 Powerpoint 線上展示連結</h4><p>1. 取得線上展示連結的方式請參考 <b><a href='/tutorials' target='#tutorials'>使用教學 </a></b>的 <b>老師-投影片廣播</b></p><p>2. 輸入線上展示連結後，記得按下 <button type='btn' class ='btn btn-primary'>儲存</button>，老師就可以開始使用Powerpoint線上簡報囉!</p> <p>2. 簡報結束後，按下 <button type='btn' class ='btn btn-warning'>清除</button> 按鈕清除輸入視窗裡面的內容，再按下<button type='btn' class ='btn btn-primary'>儲存</button> 離開視窗</p><p>3. 若不想作任何更動，請按 <button type='btn' class ='btn btn-danger'>取消</button></p><p><input id='liveCode' type='text' class='form-control' value='" +  value + "'></p>",
                            buttons: {
                                cancel: {
                                    label: "取消",
                                    className: 'btn-danger',
                                },
                                noclose: {
                                    label: "清除",
                                    className: 'btn-warning',
                                    callback: function(){
                                        document.getElementById('liveCode').value = "";
                                        return false;
                                    }
                                },
                                ok: {
                                    label: "儲存",
                                    className: 'btn-primary',
                                    callback: function(){
                                            var liveCode = document.getElementById('liveCode').value;
                                            if(liveCode != ""){
                                                firebase.database().ref("courses/" + "<%= courseName %>").child('live').set(liveCode);
                                            }else{
                                                firebase.database().ref("courses/" + "<%= courseName %>").child('live').set("");
                                            }
                                        }
                                    }
                                }
                        });
                });
                
            }
        </script>
</head>
<body onload="init();">
    <% include layouts/header %>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-8 col-md-8">
                <div id="firepad-container">
                </div>    
                <textarea class="form-control" id="showQA" readonly></textarea>
                <textarea class="form-control" id="showAsking" readonly></textarea>
            </div>
            <div class="col-sm-4 col-md-4">
                <h3><%= title %></h3>
                <div class="form-group" id="studentBlock">
                    <button id = "randomStudent" type="button" class="btn btn-success">隨機挑選學生</button>
                    <h3>你選擇的是 : <b><div id="studentName">尚未選擇</div> </b></h3>
                    <select class="form-control" id="studentSelect" size="25">
                    </select>
                </div>
            </div>
    </div>
</body>
</html>
<!DOCTYPE HTML>
<html>
<head>
        <title>教學筆記系統</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>   
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
        <!-- Firebase js -->
        <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>    
        <!-- Firepad related js -->  
        <script src="/javascripts/codemirror.js"></script>     
        <script src="/javascripts/firepad.js"></script> 
        <script src="/javascripts/firebase-init.js"></script>
        <!-- Firepad css -->
        <link rel="stylesheet" href="/stylesheets/codemirror.css" />
        <link rel="stylesheet" href="/stylesheets/firepad.css" />
        
        
        <!-- This page css -->
        <link rel="stylesheet" href="/stylesheets/notePage.css" />
        <link rel="stylesheet" href="/stylesheets/style.css">

        <script src="/javascripts/keywordOverlay.js"></script>
        <script src="/javascripts/bootbox.min.js"></script>
        

        <script>
            initFirebase();
            function init(){ 
                var userEmail = "<%= user.emails[0].value %>";
                var userEID = userEmail.split('@')[0];
                var firepadRef = firebase.database().ref('/'+'note-'+userEID).child('<%= title %>');

                var codeMirror = CodeMirror(document.getElementById('firepad-container'), { lineWrapping: true });
                hyperlinkOverlay(codeMirror);
                qaOverlay(codeMirror);
                askingOverlay(codeMirror);
                var firepad = Firepad.fromCodeMirror(firepadRef, codeMirror,
                    { richTextToolbar: true, richTextShortcuts: true , userId:"<%= user.displayName %>" }
                );
                firepad.on('ready', function() {
                    if(firepad.isHistoryEmpty()) {
                        firepad.setHtml('<span style="font-size: 24px;"><%= title %> </span>');
                    }
                });

                var watchLink = $('<li></li>').html('<a href="#" onclick="watchNote()"><span class="glyphicon glyphicon-folder-open"></span>&nbsp;&nbsp;觀看同學筆記</a>');
                $('#navList').append(watchLink);
                var liveLink = $('<li></li>').html('<a href="#" onclick="livebtn()"><span class="glyphicon glyphicon-globe"></span> 查看投影片廣播</a>');
                $('#navList').append(liveLink);
                

                var btn = document.createElement("button");
                btn.setAttribute('onclick',"slidebtn()");
                btn.setAttribute('id',"slidebtn");
                btn.setAttribute('class',"btn navbar-btn btn-info");
                btn.innerHTML = "隱藏筆記";
                var liElement = document.createElement("li");
                liElement.appendChild(btn);
                $('#navList').append(liElement);
                      
                var pptUrl = parsePPTURL("<%= pptUrl %>");
                callIframe(pptUrl);  
          }

            function callIframe(url) {
                $('#slide').html("");
                $('#slide').append('<iframe id="ppt" allowFullScreen></iframe>');
                $('#ppt').attr('src', url);

            }
            function slidebtn(){
                var btn = document.getElementById("slidebtn");
                if( btn.innerHTML == "隱藏筆記" ){
                    btn.innerHTML = "顯示筆記";
                    document.getElementById('slide').style.right = "0%";
                    document.getElementById('firepad-container').style.left = "100%";
                }
                else if ( btn.innerHTML == "顯示筆記" ){
                    btn.innerHTML = "隱藏筆記";
                    document.getElementById('slide').style.right = "50%";
                    document.getElementById('firepad-container').style.left = "50%";
                }
            }
            var pptUrl = parsePPTURL("<%= pptUrl %>");
            function livebtn(){            
                $.ajax({
                        data : {courseName : "<%= courseName %>"},
                        url: "/getLiveUrl",
                        type : 'get',
                        cache : false,
                        timeout: 1000,
                        success: function(liveUrl){
                            if(liveUrl != ""){
                                bootbox.confirm({
                                    message: "<h3>目前老師正在上課! <br>是否觀看投影片廣播 ?</h3>",
                                    buttons:{
                                        confirm: {
                                            label : '觀看',
                                            className: 'btn-success'
                                        },
                                        cancel : {
                                            label : '取消',
                                            className: 'btn-danger'
                                        }
                                    },
                                    callback: function(result){
                                        if(result){
                                            callIframe(liveUrl);
                                            if(document.getElementById('liveSwitchBtn')){ // 避免出現很多個button
                                                document.getElementById('liveSwitchBtn').remove();
                                            }
                                            var livebtn = document.createElement("button");
                                            livebtn.setAttribute('onclick',"liveSwitchBtn(this.value)");
                                            livebtn.setAttribute('value',liveUrl);
                                            livebtn.setAttribute('id',"liveSwitchBtn");
                                            livebtn.setAttribute('class',"btn btn-danger navbar-btn");
                                            livebtn.innerHTML = "切回離線投影片";
                                            var liElement = document.createElement("li");
                                            liElement.appendChild(livebtn);
                                            $('#navList').append(liElement);
                                        }
                                    }
                                });     
                            }else{
                                bootbox.alert('<h3>目前老師還沒有廣播投影片喔!</h3>');
                                if(document.getElementById('liveSwitchBtn')){ // 避免出現很多個button
                                    document.getElementById('liveSwitchBtn').remove();
                                    callIframe(pptUrl);
                                }
                            }
                        },
                        error : function(){
                            bootbox.alert('<h3>Sorry，伺服器忙碌中，請再試一次</h3>');
                        }
                }); 
            }
            function parsePPTURL(pptUrl){
                var patt = /https:.*?(quot;|#39)/;
                var match = patt.exec(pptUrl);
                var url = match[0].substr(0,match[0].length - 4);
                url = url.replace(/&amp;/g,"&");
                return url;
            }
            function watchNote(){
                var dialog = bootbox.dialog({
                    title: '請輸入同學的Email帳號',
                    message: "<p>例如 : <font color='red'>abc@gmail.com</font> 或 <font color='red'>abc@ncnu.edu.tw</font> 只要輸入 <big><font color='red'>abc</font></big> 即可</p><input id='userEID' type='text' class='form-control'>",
                    buttons: {
                        cancel: {
                            label: "取消",
                            className: 'btn-danger',
                        },
                        ok: {
                            label: "觀看",
                            className: 'btn-info',
                            callback: function(){
                                var userEID = document.getElementById('userEID').value;
                                if(userEID != "" && userEID != undefined){
                                        var firepadRef = firebase.database().ref('/'+'note-'+ userEID).child('<%= title %>');
                                        var codeMirror = CodeMirror(document.getElementById('firepad-container'), { lineWrapping: true });// Actually, you will not modify the content of firepad-container... But it has to do this to use firepad.getHtml()
                                        var shareFirepad = Firepad.fromCodeMirror(firepadRef, codeMirror,
                                            { richTextToolbar: false, richTextShortcuts: true , userId:"<%= user.displayName %>" }
                                        );
                                        shareFirepad.on('ready', function() {
                                            if(shareFirepad.getHtml() == ""){
                                                bootbox.alert('查無此人筆記，請重新輸入');            
                                            }
                                            else{
                                                bootbox.alert(shareFirepad.getHtml());
                                            }
                                            shareFirepad.dispose();
                                        });
                                }
                                else{
                                    bootbox.alert('請輸入Email帳號');
                                }
                            }
                        }
                    }
                });


            }
            function liveSwitchBtn(liveUrl){
                var switchBtn = document.getElementById("liveSwitchBtn");
                if( switchBtn.innerHTML == "切回離線投影片" ){
                    switchBtn.innerHTML = "跟隨廣播投影片";
                    callIframe(pptUrl);
                }
                else if( switchBtn.innerHTML == "跟隨廣播投影片" ){
                    switchBtn.innerHTML = "切回離線投影片";
                    callIframe(liveUrl);
                }
            }
        </script>
</head>
<body onload="init();">
    <% include layouts/header %>   
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6 col-md-6">
                <div class="embed-responsive embed-responsive" id="slide">
                </div>
            </div>
            <div class="col-sm-6 col-md-6">
                <div id="firepad-container">
                </div>
            </div>
    </div>
    
</body>
</html>